{
  "version": 3,
  "sources": ["../src/main.ts"],
  "sourcesContent": ["/*\r\n* Stromee+ Cloud-Adapter for ioBroker\r\n* Created on 23.04.2023 Lutz Helling \r\n* Created with @iobroker/create-adapter v2.4.0\r\n*/\r\n\r\nimport * as utils from \"@iobroker/adapter-core\";\r\nimport { request } from \"node:https\";\r\n\r\n\r\nclass Stromee extends utils.Adapter {\r\n\r\n\tprivate t1!: any;\r\n\tprivate auth: any = {};\r\n\tprivate token = \"\";\r\n\r\n\tpublic constructor(options: Partial<utils.AdapterOptions> = {}) {\r\n\t\tsuper({\r\n\t\t\t...options,\r\n\t\t\tname: \"stromee\",\r\n\t\t});\r\n\t\tthis.on(\"ready\", this.onReady.bind(this));\r\n\t\tthis.on(\"stateChange\", this.onStateChange.bind(this));\r\n\t\t// this.on(\"objectChange\", this.onObjectChange.bind(this));\r\n\t\t// this.on(\"message\", this.onMessage.bind(this));\r\n\t\tthis.on(\"unload\", this.onUnload.bind(this));\r\n\t}\r\n\r\n\t/**\r\n\t * Is called when databases are connected and adapter received configuration.\r\n\t */\r\n\tprivate async onReady(): Promise<void> {\r\n\t\t// The adapters config (in the instance object everything under the attribute \"native\") is accessible via\r\n\t\t// this.config:\r\n\t\tthis.log.debug(\"config deviceId: \" + this.config.deviceId);\r\n\t\tthis.log.debug(\"config deviceName: \" + this.config.deviceName);\r\n\t\tthis.log.debug(\"config user: \" + this.config.user);\r\n\t\tthis.log.debug(\"config password: \" + this.config.password);\r\n\t\tthis.log.debug(\"config updateFreq: \" + this.config.updateFreq);\r\n\r\n\t\tawait this.setObjectNotExistsAsync(\"letzterStand\", {\r\n\t\t\ttype: \"state\",\r\n\t\t\tcommon: {\r\n\t\t\t\tname: \"Letzter abgelesener Stand\",\r\n\t\t\t\ttype: \"number\",\r\n\t\t\t\trole: \"indicator\",\r\n\t\t\t\tread: true,\r\n\t\t\t\twrite: true,\r\n\t\t\t},\r\n\t\t\tnative: {},\r\n\t\t});\r\n\r\n\t\tthis.t1 = this.setInterval(() => {\r\n\t\t\tthis.doIt();\r\n\t\t}, this.config.updateFreq * 1000);\r\n\t}\r\n\r\n\tprivate doIt = (): void => {\r\n\t\tthis.log.info(\"Getting data from Stromee+-Cloud...\");\r\n\t\tif (this.isTokenInvalid()) {\r\n\t\t\tthis.getToken((response: Buffer) => {\r\n\t\t\t\tthis.auth = JSON.parse(response.toString());\r\n\t\t\t\tthis.token = this.auth.authentication.authenticationToken;\r\n\t\t\t\t// eslint-disable-next-line @typescript-eslint/no-unused-vars\r\n\t\t\t\tthis.getStaende(this.token, (response: Buffer) => {\r\n\t\t\t\t\tconst measurements = JSON.parse(response.toString());\r\n\t\t\t\t\tmeasurements.forEach((e: any) => {\r\n\t\t\t\t\t\tthis.log.debug(JSON.stringify(e));\r\n\t\t\t\t\t\tif (e.measurement == this.config.deviceId) {\r\n\t\t\t\t\t\t\tconst tsKlartext = new Date(Number(e.timestamp)).toLocaleString();\r\n\t\t\t\t\t\t\tthis.log.debug(\"Letzter Stand:\" + e.value + \" - \" + tsKlartext);\r\n\t\t\t\t\t\t\tthis.setState(\"letzterStand\", Number(e.value));\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t});\r\n\t\t\t\t});\r\n\t\t\t});\r\n\t\t} else {\r\n\t\t\tthis.getStaende(this.token, (response: Buffer) => {\r\n\t\t\t\tconst measurements = JSON.parse(response.toString());\r\n\t\t\t\tmeasurements.forEach((e: any) => {\r\n\t\t\t\t\tthis.log.debug(JSON.stringify(e));\r\n\t\t\t\t\tif (e.measurement == this.config.deviceName) {\r\n\t\t\t\t\t\tconst tsKlartext = new Date(Number(e.timestamp)).toLocaleString();\r\n\t\t\t\t\t\tthis.log.debug(\"Letzter Stand:\" + e.value + \" - \" + tsKlartext);\r\n\t\t\t\t\t\tthis.setState(\"letzterStand\", Number(e.value));\r\n\t\t\t\t\t}\r\n\t\t\t\t});\r\n\t\t\t});\r\n\r\n\t\t}\r\n\t}\r\n\r\n\tprivate isTokenInvalid(): boolean {\r\n\t\tif (!this.auth.hasOwnProperty(\"authentication\")) {\r\n\t\t\treturn true;\r\n\t\t}\r\n\t\tthis.log.debug(\"token already gained...\" + JSON.stringify(this.auth));\r\n\t\tconst maxAgeInt = Number(this.auth.authentication.expiresAt);\r\n\t\tthis.log.debug(\"maxAge:\" + maxAgeInt);\r\n\t\tthis.log.debug(\"now:\" + (new Date().getTime()))\r\n\t\tthis.log.debug(\"limit:\" + (new Date().getTime() + 1000))\r\n\t\tconst ret = !(maxAgeInt < (new Date().getTime() + 1000));\r\n\t\tthis.log.debug(\"token is valid:\" + !ret);\r\n\t\treturn ret;\r\n\t}\r\n\r\n\tprivate getStaende(token: any, callback: (buf: Buffer) => void): void {\r\n\t\tconst options = {\r\n\t\t\t\"method\": \"GET\",\r\n\t\t\t\"hostname\": \"backend.stromee-plus.stromee.de\",\r\n\t\t\t\"path\": \"/api/v1/devices/\" + this.config.deviceName + \"/measurements/latest?start=-6m\",\r\n\t\t\t\"headers\": {\r\n\t\t\t\t\"Authorization\": \"Bearer \" + token\r\n\t\t\t},\r\n\t\t\t\"maxRedirects\": 20\r\n\t\t};\r\n\r\n\t\t// eslint-disable-next-line @typescript-eslint/no-this-alias\r\n\t\tconst _self = this;\r\n\r\n\t\tconst req = request(options, function (res) {\r\n\t\t\tconst chunks: any = [];\r\n\r\n\t\t\tres.on(\"data\", function (chunk) {\r\n\t\t\t\tchunks.push(chunk);\r\n\t\t\t});\r\n\r\n\t\t\tres.on(\"end\", function () {\r\n\t\t\t\tconst body = Buffer.concat(chunks);\r\n\t\t\t\t_self.log.debug(body.toString());\r\n\t\t\t\tcallback(body);\r\n\t\t\t});\r\n\r\n\t\t\tres.on(\"error\", function (error) {\r\n\t\t\t\t_self.log.debug(error.message);\r\n\t\t\t});\r\n\t\t});\r\n\r\n\t\treq.end();\r\n\t}\r\n\r\n\tprivate getToken(callback: (res: Buffer) => any): void {\r\n\t\ttry {\r\n\r\n\t\t\tconst options = {\r\n\t\t\t\t\"method\": \"POST\",\r\n\t\t\t\t\"hostname\": \"backend.staging.stromee.de\",\r\n\t\t\t\t\"path\": \"/v0.1/account/login\",\r\n\t\t\t\t\"headers\": {\r\n\t\t\t\t\t\"Accept\": \"application/json, text/plain, */*\",\r\n\t\t\t\t\t\"Content-Type\": \"application/json\",\r\n\t\t\t\t},\r\n\t\t\t\t\"maxRedirects\": 20\r\n\t\t\t};\r\n\r\n\t\t\t// eslint-disable-next-line @typescript-eslint/no-this-alias\r\n\t\t\tconst _self = this;\r\n\t\t\tconst req = request(options, function (res) {\r\n\t\t\t\tconst chunks: any[] = [];\r\n\r\n\t\t\t\tres.on(\"data\", function (chunk) {\r\n\t\t\t\t\tchunks.push(chunk);\r\n\t\t\t\t});\r\n\r\n\t\t\t\tres.on(\"end\", function () {\r\n\t\t\t\t\tconst body = Buffer.concat(chunks);\r\n\t\t\t\t\t_self.log.debug(body.toString());\r\n\t\t\t\t\tcallback(body);\r\n\t\t\t\t});\r\n\r\n\t\t\t\tres.on(\"error\", function (error) {\r\n\t\t\t\t\tconsole.error(error);\r\n\t\t\t\t});\r\n\t\t\t});\r\n\r\n\t\t\tconst postData = JSON.stringify({\r\n\t\t\t\t\"username\": this.config.user,\r\n\t\t\t\t\"email\": this.config.user,\r\n\t\t\t\t\"password\": this.config.password,\r\n\t\t\t\t\"skipPowercloud\": true\r\n\t\t\t});\r\n\r\n\t\t\treq.write(postData);\r\n\r\n\t\t\treq.end();\r\n\t\t} finally {\r\n\t\t}\r\n\t}\r\n\r\n\t/**\r\n\t * Is called when adapter shuts down - callback has to be called under any circumstances!\r\n\t */\r\n\tprivate onUnload(callback: () => void): void {\r\n\t\ttry {\r\n\t\t\tthis.clearTimeout(this.t1);\r\n\t\t\tcallback();\r\n\t\t} catch (e) {\r\n\t\t\tcallback();\r\n\t\t}\r\n\t}\r\n\r\n\t// If you need to react to object changes, uncomment the following block and the corresponding line in the constructor.\r\n\t// You also need to subscribe to the objects with `this.subscribeObjects`, similar to `this.subscribeStates`.\r\n\t// /**\r\n\t//  * Is called if a subscribed object changes\r\n\t//  */\r\n\t// private onObjectChange(id: string, obj: ioBroker.Object | null | undefined): void {\r\n\t// \tif (obj) {\r\n\t// \t\t// The object was changed\r\n\t// \t\tthis.log.info(`object ${id} changed: ${JSON.stringify(obj)}`);\r\n\t// \t} else {\r\n\t// \t\t// The object was deleted\r\n\t// \t\tthis.log.info(`object ${id} deleted`);\r\n\t// \t}\r\n\t// }\r\n\r\n\t/**\r\n\t * Is called if a subscribed state changes\r\n\t */\r\n\tprivate onStateChange(id: string, state: ioBroker.State | null | undefined): void {\r\n\t\tif (state) {\r\n\t\t\t// The state was changed\r\n\t\t\tthis.log.info(`state ${id} changed: ${state.val} (ack = ${state.ack})`);\r\n\t\t} else {\r\n\t\t\t// The state was deleted\r\n\t\t\tthis.log.info(`state ${id} deleted`);\r\n\t\t}\r\n\t}\r\n\r\n\t// If you need to accept messages in your adapter, uncomment the following block and the corresponding line in the constructor.\r\n\t// /**\r\n\t//  * Some message was sent to this instance over message box. Used by email, pushover, text2speech, ...\r\n\t//  * Using this method requires \"common.messagebox\" property to be set to true in io-package.json\r\n\t//  */\r\n\t// private onMessage(obj: ioBroker.Message): void {\r\n\t// \tif (typeof obj === \"object\" && obj.message) {\r\n\t// \t\tif (obj.command === \"send\") {\r\n\t// \t\t\t// e.g. send email or pushover or whatever\r\n\t// \t\t\tthis.log.info(\"send command\");\r\n\r\n\t// \t\t\t// Send response in callback if required\r\n\t// \t\t\tif (obj.callback) this.sendTo(obj.from, obj.command, \"Message received\", obj.callback);\r\n\t// \t\t}\r\n\t// \t}\r\n\t// }\r\n\r\n}\r\n\r\nif (require.main !== module) {\r\n\t// Export the constructor in compact mode\r\n\tmodule.exports = (options: Partial<utils.AdapterOptions> | undefined) => new Stromee(options);\r\n} else {\r\n\t// otherwise start the instance directly\r\n\t(() => new Stromee())();\r\n}"],
  "mappings": "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",
  "names": ["response"]
}
